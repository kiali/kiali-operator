- name: Tests
  hosts: localhost
  connection: local
  collections:
  - kubernetes.core
  vars:
    custom_resource: "{{ lookup('template', cr_file_path) | from_yaml }}"
  tasks:
  - import_tasks: ../common/tasks.yml
  - import_tasks: ../asserts/pod_asserts.yml

  # Verify this is actually OpenShift - the test should only run on OpenShift
  - name: Assert that this is an OpenShift cluster
    assert:
      that:
      - is_openshift == True
      fail_msg: "This test requires an OpenShift cluster because it tests tls_config.source=auto which reads from OpenShift API Server"

  # Get the OpenShift TLSSecurityProfile from the API Server
  - name: Get OpenShift APIServer configuration
    k8s_info:
      api_version: config.openshift.io/v1
      kind: APIServer
      name: cluster
    register: openshift_apiserver

  - name: Debug OpenShift APIServer TLS profile
    debug:
      msg: "OpenShift TLSSecurityProfile: {{ openshift_apiserver.resources[0].spec.tlsSecurityProfile | default('not set - will use Intermediate') }}"

  # Determine the expected minimum TLS version based on OpenShift profile type
  - name: Determine expected minimum TLS version from OpenShift profile
    set_fact:
      openshift_profile_type: "{{ openshift_apiserver.resources[0].spec.tlsSecurityProfile.type | default('Intermediate') }}"

  - name: Set expected TLS version based on profile type
    set_fact:
      expected_min_tls_version: >-
        {%- if openshift_profile_type == 'Modern' -%}
          TLSv1.3
        {%- elif openshift_profile_type == 'Old' -%}
          TLSv1.2
        {%- elif openshift_profile_type == 'Custom' -%}
          {{ openshift_apiserver.resources[0].spec.tlsSecurityProfile.custom.minTLSVersion | default('TLSv1.2') }}
        {%- else -%}
          TLSv1.2
        {%- endif -%}

  - name: Debug expected minimum TLS version
    debug:
      msg: "OpenShift profile type [{{ openshift_profile_type }}] -> Expected min TLS version [{{ expected_min_tls_version }}]"

  # Verify the Kiali CR has tls_config.source=auto
  - name: Assert Kiali CR has tls_config.source=auto
    assert:
      that:
      - kiali_cr.spec.deployment.tls_config.source == "auto"
      fail_msg: "Expected Kiali CR to have deployment.tls_config.source=auto"

  # The key assertion: Kiali must have started successfully with auto TLS config
  - name: Assert Kiali pod is running (confirms successful TLS profile resolution)
    assert:
      that:
      - kiali_pod.resources | length > 0
      - kiali_pod.resources[0].status.phase == "Running"
      fail_msg: "Kiali pod should be running when tls_config.source=auto on OpenShift"

  # Verify the ConfigMap reflects the TLS configuration
  - name: Assert ConfigMap has TLS configuration with source=auto
    assert:
      that:
      - kiali_configmap.deployment.tls_config is defined
      - kiali_configmap.deployment.tls_config.source == "auto"
      fail_msg: "Kiali ConfigMap should show deployment.tls_config.source=auto"

  # Make a request to Kiali API to verify it's working with auto TLS config
  - name: Make request to Kiali API with source=auto
    uri:
      url: "{{ kiali_base_url }}/api"
      validate_certs: no
      return_content: yes
    register: kiali_api_auto_response

  - name: Assert Kiali API responds successfully with source=auto
    assert:
      that:
      - kiali_api_auto_response.status == 200
      fail_msg: "Kiali API should respond successfully when tls_config.source=auto"

  # ========================================
  # Test switching to explicit config mode
  # ========================================

  # Use kiali_cr from common/tasks.yml, update only the tls_config
  - name: Set tls_config.source to config with TLS 1.3
    set_fact:
      updated_tls_config: "{{ kiali_cr.spec.deployment.tls_config | combine({'source': 'config', 'min_version': 'TLSv1.3'}) }}"
      updated_deployment: "{{ kiali_cr.spec.deployment | combine({'tls_config': {'source': 'config', 'min_version': 'TLSv1.3'}}) }}"

  - import_tasks: ../common/set_kiali_cr.yml
    vars:
      new_kiali_cr: "{{ kiali_cr | combine({'spec': kiali_cr.spec | combine({'deployment': updated_deployment})}, recursive=True) }}"

  - import_tasks: ../common/wait_for_kiali_cr_changes.yml
  - import_tasks: ../common/wait_for_kiali_running.yml
  - import_tasks: ../common/tasks.yml
  - import_tasks: ../asserts/pod_asserts.yml

  # Verify the ConfigMap now reflects explicit config source
  - name: Assert ConfigMap now shows source=config with TLS 1.3
    assert:
      that:
      - kiali_configmap.deployment.tls_config.source == "config"
      - kiali_configmap.deployment.tls_config.min_version == "TLSv1.3"
      fail_msg: "Kiali ConfigMap should show deployment.tls_config.source=config after CR update"

  # Verify Kiali pod is running with explicit config
  - name: Assert Kiali pod is running with explicit TLS config
    assert:
      that:
      - kiali_pod.resources | length > 0
      - kiali_pod.resources[0].status.phase == "Running"
      fail_msg: "Kiali pod should be running with explicit tls_config"

  # Make a request to Kiali API to verify it's working with explicit config
  - name: Make request to Kiali API with explicit TLS config
    uri:
      url: "{{ kiali_base_url }}/api"
      validate_certs: no
      return_content: yes
    register: kiali_api_config_response

  - name: Assert Kiali API responds successfully with explicit config
    assert:
      that:
      - kiali_api_config_response.status == 200
      fail_msg: "Kiali API should respond successfully when tls_config.source=config"

  # ========================================
  # Switch back to auto mode
  # ========================================

  # Use the refreshed kiali_cr from common/tasks.yml
  - name: Set tls_config.source back to auto
    set_fact:
      updated_deployment_auto: "{{ kiali_cr.spec.deployment | combine({'tls_config': {'source': 'auto'}}) }}"

  - import_tasks: ../common/set_kiali_cr.yml
    vars:
      new_kiali_cr: "{{ kiali_cr | combine({'spec': kiali_cr.spec | combine({'deployment': updated_deployment_auto})}, recursive=True) }}"

  - import_tasks: ../common/wait_for_kiali_cr_changes.yml
  - import_tasks: ../common/wait_for_kiali_running.yml
  - import_tasks: ../common/tasks.yml
  - import_tasks: ../asserts/pod_asserts.yml

  # Final verification - auto mode should work again
  - name: Assert ConfigMap shows source=auto again
    assert:
      that:
      - kiali_configmap.deployment.tls_config.source == "auto"
      fail_msg: "Kiali ConfigMap should show deployment.tls_config.source=auto after switching back"

  - name: Assert Kiali pod is running after switching back to auto
    assert:
      that:
      - kiali_pod.resources | length > 0
      - kiali_pod.resources[0].status.phase == "Running"
      fail_msg: "Kiali pod should be running after switching back to tls_config.source=auto"

  # Final API request to confirm everything works
  - name: Make final request to Kiali API after switching back to auto
    uri:
      url: "{{ kiali_base_url }}/api"
      validate_certs: no
      return_content: yes
    register: kiali_api_final_response

  - name: Assert final Kiali API request succeeds
    assert:
      that:
      - kiali_api_final_response.status == 200
      fail_msg: "Kiali API should respond after switching back to auto mode"

  - name: Test completed successfully
    debug:
      msg: |
        TLS profile test completed successfully:
        - Verified Kiali reads OpenShift TLSSecurityProfile when source=auto
        - Kiali started successfully and responds to API requests
        - Verified switching between auto and explicit config modes works
        - OpenShift profile type: {{ openshift_profile_type }}
        - Expected min TLS version: {{ expected_min_tls_version }}

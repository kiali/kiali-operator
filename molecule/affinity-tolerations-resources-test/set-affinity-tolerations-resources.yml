- name: Set affinity and tolerations and resources and pod_annotations and service_annotations in current Kiali CR that is not undergoing reconciliation
  vars:
    current_kiali_cr: "{{ lookup('k8s', api_version='kiali.io/v1alpha1', kind='Kiali', namespace=cr_namespace, resource_name=custom_resource.metadata.name) }}"
  set_fact:
    new_kiali_cr: "{{ current_kiali_cr | combine({'spec': {'deployment': {'affinity': new_affinity, 'tolerations': new_tolerations, 'resources': new_resources, 'pod_annotations': new_pod_annotations, 'service_annotations': new_service_annotations }}}, recursive=True) }}"
  until:
  - new_kiali_cr is defined
  - new_kiali_cr.status is defined
  - new_kiali_cr.status.conditions | length > 0
  - new_kiali_cr.status.conditions[0].ansibleResult is defined
  retries: "{{ wait_retries }}"
  delay: 5


- name: Change Kiali CR with new affinity and tolerations and resources and pod_annotations and service_annotations
  import_tasks: ../common/set_kiali_cr.yml
